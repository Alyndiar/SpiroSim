name: Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) {
            python -m pip install -r requirements.txt
          }
          python -m pip install pyinstaller PySide6

      - name: Install dependencies (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          python -m pip install pyinstaller PySide6

      - name: Setup GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: "5.x"

      - name: Determine version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1
        with:
          useConfigFile: true

      - name: Generate version metadata
        env:
          SEMVER: ${{ steps.gitversion.outputs.fullSemVer }}
          SHA: ${{ steps.gitversion.outputs.shortSha }}
        run: |
          python scripts/generate_version.py

      - name: Build
        run: pyinstaller --noconfirm --clean --onefile SpiroSim.py

      - name: Package artifact
        shell: python
        env:
          VERSION: ${{ steps.gitversion.outputs.fullSemVer }}
        run: |
          import os
          import pathlib
          import shutil

          version = os.environ.get("VERSION", "0.0.0-dev")
          runner_os = os.environ.get("RUNNER_OS", "unknown")
          dist_path = pathlib.Path("dist")
          if runner_os == "Windows":
            source = dist_path / "SpiroSim.exe"
          else:
            source = dist_path / "SpiroSim"
          out_dir = pathlib.Path("out")
          out_dir.mkdir(exist_ok=True)
          target = out_dir / f"SpiroSim-{runner_os}-{version}{source.suffix}"
          shutil.copy2(source, target)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SpiroSim-${{ matrix.os }}-${{ steps.gitversion.outputs.fullSemVer }}
          path: out/
